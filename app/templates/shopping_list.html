{% extends 'base.html' %}
{% block content %}
<div class="printable-content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1><i class="fas fa-cart-arrow-down"></i> Smart Shopping List</h1>
    <button onclick="window.print()" class="btn btn-secondary no-print"><i class="fas fa-print"></i> Print List</button>
  </div>
  <p class="text-muted no-print">Calculated from your meal plan, pantry, and manually added items.</p>

  <div class="row">
    <div class="col-md-8">
      <!-- Card for manually adding items -->
      <div class="card mb-4 no-print">
        <div class="card-body">
          <h5 class="card-title">Add Item Manually</h5>
          <form method="POST" action="{{ url_for('main.shopping_list') }}">
            <input type="hidden" name="action" value="add_manual_item">
            <div class="form-row">
                <div class="form-group col-sm-6">
                    <label for="name">Item Name</label>
                    <input type="text" class="form-control" name="name" id="name" placeholder="e.g., Paper Towels" required>
                </div>
                <div class="form-group col-sm-6">
                  <label for="category">Category</label>
                  <select name="category" id="category" class="form-control">
                      <option value="Household">Household</option>
                      <option value="Personal Care">Personal Care</option>
                      <option value="Pets">Pets</option>
                      <option value="Other">Other</option>
                      <option disabled>-- Food --</option>
                      <option value="Produce">Produce</option>
                      <option value="Meat & Seafood">Meat & Seafood</option>
                      <option value="Dairy & Eggs">Dairy & Eggs</option>
                      <option value="Pantry">Pantry</option>
                  </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add</button>
          </form>
        </div>
      </div>

      <div class="card h-100">
        <div class="card-header">
          <h5>What You Need to Buy</h5>
        </div>
        <div class="card-body">
          {% if not stores %}
            <div class="alert alert-info no-print">
              <strong>Tip:</strong> <a href="{{ url_for('main.profile') }}">Add your favorite grocery stores</a> on your Profile page to enable quick search links here!
            </div>
          {% endif %}
          
          {% if grouped_list %}
            {% for aisle, items in grouped_list.items()|sort %}
              <h4 class="mt-3">{{ aisle }}</h4>
              <ul class="list-group list-group-flush">
                {% for name, details in items.items() %}
                  <li class="list-group-item shopping-item d-flex align-items-center">
                    <input type="checkbox" class="mr-3 item-checkbox">
                    <span class="item-text flex-grow-1">
                      {% if details.manual_id %}
                        <strong>{{ name }}</strong>
                      {% else %}
                        {% if details.quantity %}
                          Buy <strong>{{ "%.2f"|format(details.quantity) }}</strong> {{ details.units|select|join(', ') }} of <strong>{{ name }}</strong>
                        {% else %}
                          <strong>{{ name }}</strong>
                        {% endif %}
                      {% endif %}
                      {% if details.note and not details.manual_id %}
                        <br><small class="text-danger font-italic no-print"><i class="fas fa-exclamation-triangle"></i> {{ details.note }}</small>
                      {% endif %}
                    </span>

                    <div class="btn-group no-print" role="group">
                      {% for store in stores %}
                        {% if loop.index <= 3 %}
                          <a href="{{ store.search_url.replace('{query}', name|urlencode) }}" target="_blank" class="btn btn-primary btn-sm" title="Search {{ store.name }}">
                            <i class="fas fa-search"></i> {{ store.name }}
                          </a>
                        {% endif %}
                      {% endfor %}
                    </div>
                    
                    {% if details.manual_id %}
                      <form method="POST" action="{{ url_for('main.shopping_list') }}" class="ml-2 no-print">
                        <input type="hidden" name="action" value="delete_manual_item">
                        <input type="hidden" name="item_id" value="{{ details.manual_id }}">
                        <button type="submit" class="btn btn-light btn-sm" title="Delete Item">&times;</button>
                      </form>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endfor %}
          {% else %}
            <p>Your shopping list is empty. Add items from your meal plan or manually above.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-4 no-print">
      <div class="card h-100">
        <div class="card-header">
          <h5>In Your Pantry (For This Week)</h5>
        </div>
        <div class="card-body">
          {% if ingredients_in_pantry %}
            <ul class="list-group list-group-flush">
              {% for name, pantry_item in ingredients_in_pantry.items() %}
                <li class="list-group-item text-muted">
                  <i class="fas fa-check-circle text-success"></i>
                  You have {{ pantry_item.quantity }} {{ pantry_item.unit }} of <strong>{{ name }}</strong>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>None of this week's required ingredients are in your pantry.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                this.closest('.shopping-item').classList.toggle('completed', this.checked);
            });
        });
    });
  </script>
{% endblock %}